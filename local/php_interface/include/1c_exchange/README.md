# Система отладки обмена с 1С

Данная система предназначена для детального логирования и отладки процесса обмена между Bitrix CMS и 1С-УТ.

## Структура системы

1. **Файлы отладки**:

    - `/bitrix/admin/1c_exchange_custom.php` - Основной файл для обработки запросов от 1С
    - `/bitrix/admin/1c_exchange_debug.php` - Файл отладки, который запускает стандартный обмен с логированием
    - `/bitrix/admin/1c_exchange_log_viewer.php` - Административный интерфейс для просмотра логов обмена

2. **Классы**:

    - `\Local\Exchange\DebugExchangeLogger` - Класс для логирования событий обмена с 1С
    - `\Local\Exchange\CustomExchangeEventHandler` - Обработчик событий для отслеживания всех этапов обмена
    - `\Local\Exchange\LogViewer` - Класс для просмотра собранных логов
    - `\Local\Exchange\CustomSaleExport` - Класс для логирования экспорта заказов

3. **Файлы инициализации**:
    - `/local/php_interface/include/1c_exchange_init.php` - Файл, который инициализирует систему и подключает необходимые классы

## Как это работает

1. Программист 1С должен в настройках узла обмена указать путь к файлу `/bitrix/admin/1c_exchange_custom.php` вместо стандартного
2. Этот файл определяет режим работы и вызывает `/bitrix/admin/1c_exchange_debug.php`
3. Отладочный файл запускает стандартный обмен с 1С, но с полным логированием действий
4. В процессе обмена логируются:
    - Все HTTP-запросы и ответы
    - События создания/изменения элементов каталога
    - События создания/изменения заказов
    - SQL-запросы
    - Время выполнения операций
    - Используемая память
    - Работа с ZIP-архивами

## Диагностика проблем с ZIP-архивами

Система имеет специальную логику для отладки проблем с ZIP-архивами:

1. Автоматически определяется, включена ли настройка "Использовать zip, если доступно" в Битрикс
2. Проверяется доступность функций PHP для работы с ZIP
3. При загрузке ZIP-архива система:
    - Логирует информацию о файле (размер, расширение)
    - Проверяет структуру архива
    - Логирует содержимое архива и структуру файлов внутри
    - Фиксирует возможные ошибки при открытии и распаковке архива

Если при обмене возникла ошибка с ZIP-архивами, в логе будет полная информация, включая:

-   Настройки ZIP в Битрикс
-   Поддержка ZIP в текущей конфигурации PHP
-   Информация о загруженном архиве
-   Ошибки, возникшие при открытии/чтении архива

## Просмотр логов

Просмотр логов доступен через административный интерфейс:

-   В административной панели перейдите в меню "Настройки" -> "Логи обмена с 1С"
-   В интерфейсе вы увидите список запросов от 1С с основной информацией
-   Для каждого запроса можно просмотреть детальный лог операций
-   Также доступны функции очистки и удаления отдельных логов

## Настройка для программиста 1С

Чтобы использовать систему отладки, программист 1С должен:

1. Изменить адрес веб-сервиса в настройках узла обмена 1С:

    - Вместо: `http://сайт/bitrix/admin/1c_exchange.php`
    - Указать: `http://сайт/bitrix/admin/1c_exchange_custom.php`

2. Все обычные параметры обмена остаются прежними:

    - type
    - mode
    - sessid
    - версия
    - и т.д.

3. Система отладки полностью прозрачна для 1С и не требует других изменений

## Диагностика проблем

1. Если логи не создаются:

    - Проверьте права доступа к директории `/upload/1c_exchange_logs/`
    - Убедитесь, что запросы от 1С проходят через наш отладочный файл
    - Проверьте наличие всех необходимых классов в папке `/local/php_interface/include/1c_exchange/`

2. При ошибках в работе обмена:
    - Проверьте лог-файл на наличие ошибок
    - Проанализируйте SQL-запросы и время их выполнения
    - Обратите внимание на сообщения об ошибках в разделе "Лог ошибок"
    - При проблемах с ZIP-архивами изучите соответствующий раздел логов

## Дополнительные возможности

-   Можно добавить дополнительные обработчики событий в `CustomExchangeEventHandler.php`
-   Для логирования дополнительных действий используйте метод `$logger->info()` или `$logger->error()`
-   При необходимости расширить функционал просмотра логов, модифицируйте `LogViewer.php`

## Лимиты и производительность

Система отладки может увеличить время выполнения обмена и потребление памяти. Учитывайте это при настройке:

-   В файле `/bitrix/admin/1c_exchange_debug.php` установлены увеличенные лимиты памяти и времени выполнения
-   При необходимости эти значения можно изменить в соответствии с возможностями сервера
-   Для продакшн-среды рекомендуется отключать детальное логирование после диагностики проблем

## Безопасность

-   Доступ к просмотру логов ограничен пользователями с правами администратора
-   Логи могут содержать конфиденциальную информацию, удаляйте их после диагностики проблем
-   Не оставляйте включенным режим отладки на продакшн-сервере после устранения проблем
